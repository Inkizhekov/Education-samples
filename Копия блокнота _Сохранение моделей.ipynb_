{"cells":[{"cell_type":"markdown","id":"d0a07968","metadata":{"id":"d0a07968"},"source":["# Импорт библиотек"]},{"cell_type":"code","execution_count":1,"id":"6898e25c","metadata":{"id":"6898e25c","executionInfo":{"status":"ok","timestamp":1665213388523,"user_tz":-420,"elapsed":3447,"user":{"displayName":"Анатолий Инкижеков","userId":"04854426355593330927"}}},"outputs":[],"source":["import numpy as np\n","import tensorflow as tf\n","from tensorflow import keras"]},{"cell_type":"raw","id":"3e77f20f","metadata":{"id":"3e77f20f"},"source":["tf.keras"]},{"cell_type":"markdown","id":"6386abe3","metadata":{"id":"6386abe3"},"source":["Версии"]},{"cell_type":"code","execution_count":2,"id":"97adb49f","metadata":{"colab":{"base_uri":"https://localhost:8080/","height":36},"id":"97adb49f","executionInfo":{"status":"ok","timestamp":1665213391856,"user_tz":-420,"elapsed":543,"user":{"displayName":"Анатолий Инкижеков","userId":"04854426355593330927"}},"outputId":"b25cc05d-9af5-4ce7-b901-c3c737936cda"},"outputs":[{"output_type":"execute_result","data":{"text/plain":["'2.8.2'"],"application/vnd.google.colaboratory.intrinsic+json":{"type":"string"}},"metadata":{},"execution_count":2}],"source":["tf.__version__"]},{"cell_type":"code","execution_count":3,"id":"46070f52","metadata":{"colab":{"base_uri":"https://localhost:8080/","height":36},"id":"46070f52","executionInfo":{"status":"ok","timestamp":1665213394471,"user_tz":-420,"elapsed":314,"user":{"displayName":"Анатолий Инкижеков","userId":"04854426355593330927"}},"outputId":"8e866d8e-8738-483e-b714-e2299acd2421"},"outputs":[{"output_type":"execute_result","data":{"text/plain":["'1.21.6'"],"application/vnd.google.colaboratory.intrinsic+json":{"type":"string"}},"metadata":{},"execution_count":3}],"source":["np.__version__"]},{"cell_type":"code","execution_count":4,"id":"efb01da0","metadata":{"colab":{"base_uri":"https://localhost:8080/","height":36},"id":"efb01da0","executionInfo":{"status":"ok","timestamp":1665213398117,"user_tz":-420,"elapsed":316,"user":{"displayName":"Анатолий Инкижеков","userId":"04854426355593330927"}},"outputId":"39b1559c-919b-4006-ca38-2653ab109a02"},"outputs":[{"output_type":"execute_result","data":{"text/plain":["'3.7.14 (default, Sep  8 2022, 00:06:44) \\n[GCC 7.5.0]'"],"application/vnd.google.colaboratory.intrinsic+json":{"type":"string"}},"metadata":{},"execution_count":4}],"source":["import sys\n","sys.version"]},{"cell_type":"markdown","id":"c423d529","metadata":{"id":"c423d529"},"source":["---"]},{"cell_type":"markdown","id":"816e0711","metadata":{"id":"816e0711"},"source":["# Сохранение базовой модели"]},{"cell_type":"markdown","id":"2cd0e8e6","metadata":{"id":"2cd0e8e6"},"source":["Пример модели"]},{"cell_type":"code","execution_count":5,"id":"3c095da0","metadata":{"id":"3c095da0","executionInfo":{"status":"ok","timestamp":1665213403294,"user_tz":-420,"elapsed":2,"user":{"displayName":"Анатолий Инкижеков","userId":"04854426355593330927"}}},"outputs":[],"source":["def get_model():\n","    inputs = keras.Input(shape=(32,))\n","    outputs = keras.layers.Dense(1)(inputs)\n","    \n","    model = keras.Model(inputs, outputs)\n","    \n","    model.compile(optimizer=\"adam\", loss=\"mean_squared_error\")\n","    \n","    return model"]},{"cell_type":"code","execution_count":6,"id":"833e3b3c","metadata":{"id":"833e3b3c","executionInfo":{"status":"ok","timestamp":1665213412687,"user_tz":-420,"elapsed":310,"user":{"displayName":"Анатолий Инкижеков","userId":"04854426355593330927"}}},"outputs":[],"source":["model = get_model()"]},{"cell_type":"code","execution_count":7,"id":"f706acb0","metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"f706acb0","executionInfo":{"status":"ok","timestamp":1665213414938,"user_tz":-420,"elapsed":307,"user":{"displayName":"Анатолий Инкижеков","userId":"04854426355593330927"}},"outputId":"fb5505d9-1a43-4343-a13b-921733be77cb"},"outputs":[{"output_type":"stream","name":"stdout","text":["Model: \"model\"\n","_________________________________________________________________\n"," Layer (type)                Output Shape              Param #   \n","=================================================================\n"," input_1 (InputLayer)        [(None, 32)]              0         \n","                                                                 \n"," dense (Dense)               (None, 1)                 33        \n","                                                                 \n","=================================================================\n","Total params: 33\n","Trainable params: 33\n","Non-trainable params: 0\n","_________________________________________________________________\n"]}],"source":["model.summary()"]},{"cell_type":"code","execution_count":8,"id":"7c1eb353","metadata":{"id":"7c1eb353","executionInfo":{"status":"ok","timestamp":1665213418384,"user_tz":-420,"elapsed":366,"user":{"displayName":"Анатолий Инкижеков","userId":"04854426355593330927"}}},"outputs":[],"source":["# Имитация набора данных\n","test_input = np.random.random((2048, 32))\n","test_target = np.random.random((2048, 1))"]},{"cell_type":"code","execution_count":null,"id":"c11a15fc","metadata":{"id":"c11a15fc"},"outputs":[],"source":["test_input.shape"]},{"cell_type":"code","execution_count":null,"id":"6491db2e","metadata":{"id":"6491db2e"},"outputs":[],"source":["test_input"]},{"cell_type":"code","execution_count":null,"id":"65656bf2","metadata":{"id":"65656bf2"},"outputs":[],"source":["model.fit(test_input, test_target, epochs=4)"]},{"cell_type":"code","execution_count":null,"id":"1ae185f9","metadata":{"id":"1ae185f9"},"outputs":[],"source":["model.fit(test_input, test_target, epochs=10)"]},{"cell_type":"code","execution_count":null,"id":"e81039e7","metadata":{"id":"e81039e7"},"outputs":[],"source":["?model.fit"]},{"cell_type":"markdown","id":"f20df27b","metadata":{"id":"f20df27b"},"source":["Сохранение"]},{"cell_type":"code","execution_count":null,"id":"05fc8420","metadata":{"id":"05fc8420"},"outputs":[],"source":["model_path = \"my_model_1\""]},{"cell_type":"code","execution_count":null,"id":"fbc2ebe9","metadata":{"id":"fbc2ebe9"},"outputs":[],"source":["model.save(model_path)"]},{"cell_type":"markdown","id":"1dda1f4a","metadata":{"id":"1dda1f4a"},"source":["Загрузка модели"]},{"cell_type":"code","execution_count":null,"id":"6ef69142","metadata":{"id":"6ef69142"},"outputs":[],"source":["reconstructed_model = keras.models.load_model(model_path)"]},{"cell_type":"code","execution_count":null,"id":"49331f8a","metadata":{"id":"49331f8a"},"outputs":[],"source":["reconstructed_model.summary()"]},{"cell_type":"code","execution_count":null,"id":"174984b2","metadata":{"id":"174984b2"},"outputs":[],"source":["model.summary()"]},{"cell_type":"markdown","id":"032f0716","metadata":{"id":"032f0716"},"source":["Сравнение моделей"]},{"cell_type":"code","execution_count":null,"id":"8c2df551","metadata":{"id":"8c2df551"},"outputs":[],"source":["np.testing.assert_allclose(model.predict(test_input), \n","                           reconstructed_model.predict(test_input))"]},{"cell_type":"code","execution_count":null,"id":"fb23dd41","metadata":{"id":"fb23dd41"},"outputs":[],"source":["np.testing.assert_allclose(model.predict(test_input), \n","                           test_target)"]},{"cell_type":"code","execution_count":null,"id":"363ad754","metadata":{"id":"363ad754"},"outputs":[],"source":["?np.testing.assert_allclose"]},{"cell_type":"code","execution_count":null,"id":"2be1dd27","metadata":{"id":"2be1dd27"},"outputs":[],"source":["model == reconstructed_model"]},{"cell_type":"code","execution_count":null,"id":"3261a844","metadata":{"id":"3261a844"},"outputs":[],"source":["model"]},{"cell_type":"code","execution_count":null,"id":"9c78252b","metadata":{"id":"9c78252b"},"outputs":[],"source":["reconstructed_model"]},{"cell_type":"code","execution_count":null,"id":"1b93b6ad","metadata":{"id":"1b93b6ad"},"outputs":[],"source":["0.40000 == 0.399999999999999999999"]},{"cell_type":"markdown","id":"df67b438","metadata":{"id":"df67b438"},"source":["Продолжение обучения"]},{"cell_type":"code","execution_count":null,"id":"79026bc5","metadata":{"id":"79026bc5"},"outputs":[],"source":["reconstructed_model.fit(test_input, test_target, epochs=5)"]},{"cell_type":"code","execution_count":null,"id":"2bec0c18","metadata":{"scrolled":true,"id":"2bec0c18"},"outputs":[],"source":["np.testing.assert_allclose(model.predict(test_input), \n","                           reconstructed_model.predict(test_input))"]},{"cell_type":"code","execution_count":null,"id":"4bfae6ad","metadata":{"id":"4bfae6ad"},"outputs":[],"source":["model.evaluate(test_input, test_target)"]},{"cell_type":"code","execution_count":null,"id":"d18a279a","metadata":{"scrolled":true,"id":"d18a279a"},"outputs":[],"source":["reconstructed_model.evaluate(test_input, test_target)"]},{"cell_type":"code","execution_count":null,"id":"a55c7e83","metadata":{"id":"a55c7e83"},"outputs":[],"source":["path = \"my_model_1\""]},{"cell_type":"code","execution_count":null,"id":"1d59b61a","metadata":{"id":"1d59b61a"},"outputs":[],"source":["reconstructed_model = keras.models.load_model(path)"]},{"cell_type":"code","execution_count":null,"id":"45100a64","metadata":{"id":"45100a64"},"outputs":[],"source":["reconstructed_model.evaluate(test_input, test_target)"]},{"cell_type":"code","execution_count":null,"id":"c69c6f47","metadata":{"id":"c69c6f47"},"outputs":[],"source":["np.testing.assert_allclose(model.predict(test_input), \n","                           reconstructed_model.predict(test_input))"]},{"cell_type":"code","execution_count":null,"id":"52c56e69","metadata":{"id":"52c56e69"},"outputs":[],"source":["reconstructed_model.fit(test_input, test_target, epochs=5)"]},{"cell_type":"code","execution_count":null,"id":"3b1662dc","metadata":{"id":"3b1662dc"},"outputs":[],"source":["path_2 = \"model_2\"\n","reconstructed_model.save(path_2)"]},{"cell_type":"markdown","id":"35b429ec","metadata":{"id":"35b429ec"},"source":["# Сохранение в формате keras h5"]},{"cell_type":"markdown","id":"6ed4747d","metadata":{"id":"6ed4747d"},"source":["## Базовая модель"]},{"cell_type":"code","execution_count":null,"id":"973f20ff","metadata":{"id":"973f20ff"},"outputs":[],"source":["def get_model():\n","    inputs = keras.Input(shape=(32,))\n","    outputs = keras.layers.Dense(1)(inputs)\n","    model = keras.Model(inputs, outputs)\n","    \n","    model.compile(optimizer=\"adam\", loss=\"mean_squared_error\")\n","    \n","    return model"]},{"cell_type":"code","execution_count":null,"id":"ecda0edf","metadata":{"id":"ecda0edf"},"outputs":[],"source":["model = get_model()"]},{"cell_type":"code","execution_count":null,"id":"1de50b7e","metadata":{"id":"1de50b7e"},"outputs":[],"source":["model.summary()"]},{"cell_type":"code","execution_count":null,"id":"a8c3f842","metadata":{"id":"a8c3f842"},"outputs":[],"source":["test_input = np.random.random((2048, 32))\n","test_target = np.random.random((2048, 1))\n","\n","model.fit(test_input, test_target, epochs=4)"]},{"cell_type":"markdown","id":"72781df3","metadata":{"id":"72781df3"},"source":["Сохранение"]},{"cell_type":"code","execution_count":null,"id":"eff569e5","metadata":{"id":"eff569e5"},"outputs":[],"source":["keras_model_path_1 = \"my_keras_model.h5\""]},{"cell_type":"code","execution_count":null,"id":"e999a1b9","metadata":{"id":"e999a1b9"},"outputs":[],"source":["model.save(keras_model_path_1, save_format=\"h5\")"]},{"cell_type":"markdown","id":"0154d383","metadata":{"id":"0154d383"},"source":["Загрузка модели"]},{"cell_type":"code","execution_count":null,"id":"0c3a9810","metadata":{"id":"0c3a9810"},"outputs":[],"source":["reconstructed_model = keras.models.load_model(keras_model_path_1)"]},{"cell_type":"code","execution_count":null,"id":"60024727","metadata":{"id":"60024727"},"outputs":[],"source":["reconstructed_model.summary()"]},{"cell_type":"markdown","id":"d425c2d6","metadata":{"id":"d425c2d6"},"source":["Сравнение моделей"]},{"cell_type":"code","execution_count":null,"id":"6dd7408f","metadata":{"id":"6dd7408f"},"outputs":[],"source":["np.testing.assert_allclose(model.predict(test_input), \n","                           reconstructed_model.predict(test_input))"]},{"cell_type":"markdown","id":"17fab60f","metadata":{"id":"17fab60f"},"source":["Продолжение обучения"]},{"cell_type":"code","execution_count":null,"id":"31cb6d7d","metadata":{"id":"31cb6d7d"},"outputs":[],"source":["reconstructed_model.fit(test_input, test_target, epochs=3)"]},{"cell_type":"code","execution_count":null,"id":"318691c1","metadata":{"id":"318691c1"},"outputs":[],"source":["np.testing.assert_allclose(model.predict(test_input), \n","                           reconstructed_model.predict(test_input))"]},{"cell_type":"code","execution_count":null,"id":"e9564dcb","metadata":{"id":"e9564dcb"},"outputs":[],"source":["reconstructed_model.save(\"my_keras_model_retrained_3_epoch.h5\", save_format=\"h5\")"]},{"cell_type":"markdown","id":"38516742","metadata":{"id":"38516742"},"source":["---"]},{"cell_type":"code","execution_count":null,"id":"a15cb17a","metadata":{"id":"a15cb17a"},"outputs":[],"source":[]},{"cell_type":"code","execution_count":null,"id":"fe102fa8","metadata":{"id":"fe102fa8"},"outputs":[],"source":[]},{"cell_type":"code","execution_count":null,"id":"dfcfdb95","metadata":{"id":"dfcfdb95"},"outputs":[],"source":[]}],"metadata":{"kernelspec":{"display_name":"Python 3 (ipykernel)","language":"python","name":"python3"},"language_info":{"codemirror_mode":{"name":"ipython","version":3},"file_extension":".py","mimetype":"text/x-python","name":"python","nbconvert_exporter":"python","pygments_lexer":"ipython3","version":"3.8.12"},"colab":{"provenance":[{"file_id":"1rGYEwKceasWgf-e6Hd0vVd8eKUKkxgkA","timestamp":1665213433867}]}},"nbformat":4,"nbformat_minor":5}